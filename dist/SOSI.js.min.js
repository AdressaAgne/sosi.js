/*! SOSI.js 07-10-2013 */
var SOSI=window.SOSI||{};!function(a){"use strict";a.Base=function(){this.initialize.apply(this,arguments)},_.extend(a.Base.prototype,{initialize:function(){}}),a.Base.extend=function(a,b){var c,d=this;c=a&&_.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},_.extend(c,d,b);var e=function(){this.constructor=c};return e.prototype=d.prototype,c.prototype=new e,a&&_.extend(c.prototype,a),c.__super__=d.prototype,c}}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";a.util={cleanupLine:function(a){return-1!==a.indexOf("!")&&(a=a.substring(0,a.indexOf("!"))),a.replace(/\s\s*$/,"")},countStartingDots:function(a){var b=!1;return _.reduce(a,function(a,c){return"."!==c||b?b=!0:a+=1,a},0)},parseQuality:function(a){if(!a)return null;var b=["maalemetode","noyaktighet","synbarhet","h-maalemetode","h-noyaktighet","max-avvik"];if(_.isString(a))return _.reduce(a.split(" "),function(a,c,d){return a[b[d]]=parseInt(c,10),a},{});throw new Error("Reading KVALITET as subfields not implemented!")},round:function(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c}},a.koordsysMap={1:"EPSG:27391",2:"EPSG:27392",3:"EPSG:27393",4:"EPSG:27394",5:"EPSG:27395",6:"EPSG:27396",7:"EPSG:27397",8:"EPSG:27398",9:"EPSG:4273",21:"EPSG:32631",22:"EPSG:32632",23:"EPSG:32633",24:"EPSG:32634",25:"EPSG:32635",26:"EPSG:32636"},proj4&&(proj4.defs("EPSG:32631","+proj=utm +zone=31 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:32632","+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:32633","+proj=utm +zone=33 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:32634","+proj=utm +zone=34 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:32635","+proj=utm +zone=35 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:32635","+proj=utm +zone=35 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:27391","+proj=tmerc +lat_0=58 +lon_0=-4.666666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"),proj4.defs("EPSG:27392","+proj=tmerc +lat_0=58 +lon_0=-2.333333333333333 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"),proj4.defs("EPSG:27393","+proj=tmerc +lat_0=58 +lon_0=0 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"),proj4.defs("EPSG:27394","+proj=tmerc +lat_0=58 +lon_0=2.5 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"),proj4.defs("EPSG:27395","+proj=tmerc +lat_0=58 +lon_0=6.166666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"),proj4.defs("EPSG:27396","+proj=tmerc +lat_0=58 +lon_0=10.16666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"),proj4.defs("EPSG:27397","+proj=tmerc +lat_0=58 +lon_0=14.16666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"),proj4.defs("EPSG:27398","+proj=tmerc +lat_0=58 +lon_0=18.33333333333333 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"),proj4.defs("EPSG:4273","+proj=longlat +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +no_defs"))}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a){var b=a.split(" "),c={};return c[b.shift()]=b.join(" "),c}function c(a,b){var c=a[b]||"";return c.replace(/"/g,"")}function d(a,b){return parseFloat(a[b])}function e(b){if(b=parseInt(b,10),a.koordsysMap[b])return a.koordsysMap[b];throw new Error("KOORDSYS = "+b+" not found!")}function f(a){var b=a["MIN-NØ"].split(" "),c=a["MAX-NØ"].split(" ");return[parseFloat(b[1]),parseFloat(b[0]),parseFloat(c[1]),parseFloat(c[0])]}function g(a){return a=_.filter(a.split(" "),function(a){return""!==a}),{x:parseFloat(a[1]),y:parseFloat(a[0])}}a.Head=a.Base.extend({initialize:function(a){this.setData(a)},parse:function(c){var d,e=_.reduce(c,function(c,e){return e=a.util.cleanupLine(e),2===a.util.countStartingDots(e)?(e=e.replace("..",""),1===e.split(" ").length?(c[e]=[],d=e):_.extend(c,b(e))):c[d].push(e),c},{});return _.reduce(e,function(a,c,d){return a[d]=_.isArray(c)?_.reduce(c,function(a,c){return _.extend(a,b(c.replace("...","")))},{}):c,a},{})},setData:function(b){b=this.parse(b),this.eier=c(b,"EIER"),this.produsent=c(b,"PRODUSENT"),this.objektkatalog=c(b,"OBJEKTKATALOG"),this.verifiseringsdato=c(b,"VERIFISERINGSDATO"),this.version=d(b,"SOSI-VERSJON"),this.level=d(b,"SOSI-NIVÅ"),this.kvalitet=a.util.parseQuality(b.KVALITET),this.bbox=f(b.OMRÅDE),this.origo=g(b.TRANSPAR["ORIGO-NØ"]),this.enhet=parseFloat(b.TRANSPAR.ENHET),this.vertdatum=c(b.TRANSPAR,"VERT-DATUM"),this.srid=e(b.TRANSPAR.KOORDSYS)}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a,b){var c=_.flatten(_.map(a,function(a){var c=Math.abs(a),d=b.getById(c);if(!d)throw new Error("Fant ikke KURVE "+c+" for FLATE");var e=d.geometry.kurve;return 0>a&&(e=e.reverse()),_.initial(e)}));return c.push(c[0]),c}a.Point=a.Base.extend({knutepunkt:!1,initialize:function(b,c,d){_.isArray(b)&&(b=b[1]);var e=b.split(" ");this.y=a.util.round(parseInt(e[0],10)*d+c.y,2),this.x=a.util.round(parseInt(e[1],10)*d+c.x,2),e[2]&&!isNaN(e[2])&&(this.z=parseInt(e[1],10)*d),-1!==b.indexOf(".KP")&&this.setTiepoint(b.substring(b.indexOf(".KP"),b.length).split(" ")[1])},setTiepoint:function(a){this.has_tiepoint=!0,this.knutepunktkode=parseInt(a,10)}}),a.LineString=a.Base.extend({initialize:function(b,c,d){this.kurve=_.compact(_.map(b,function(b){return-1===b.indexOf("NØ")?new a.Point(b,c,d):void 0})),this.knutepunkter=_.filter(this.kurve,function(a){return a.has_tiepoint})}}),a.Polygon=a.Base.extend({initialize:function(a,c){var d=-1;a=_.reduce(a.split(" "),function(a,b){return b=b.replace(/:/g,""),-1!==b.indexOf("(")&&(d+=1,a.holes.push([]),b=b.replace("(","")),-1!==b.indexOf(")")&&(b=b.replace(")","")),-1===d?a.shell.push(parseInt(b,10)):a.holes[d].push(parseInt(b,10)),a},{holes:[],shell:[]}),this.flate=b(a.shell,c),this.holes=_.map(a.holes,function(a){if(1===a.length){var d=c.getById(a[0]);if("FLATE"===d.geometryType)return d.geometry.flate}return b(a,c)})}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(b,c,d,e){var f={PUNKT:a.Point,KURVE:a.LineString,FLATE:a.Polygon};return f[b]?new f[b](c,d,e):null}var c={KVALITET:{name:"kvalitet","function":a.util.parseQuality}};a.Feature=a.Base.extend({initialize:function(a,b,c,d){if(!a.id)throw new Error("Feature must have ID!");this.id=a.id,this.parseData(a,b,c,d),this.geometryType=a.geometryType},parseData:function(d,e,f,g){var h=!1,i=_.reduce(d.lines,function(b,c){return c=a.util.cleanupLine(c).replace("..",""),-1!==c.indexOf("NØ")&&(h=!0),h?b.geometry.push(c):b.attributes.push(c),b},{attributes:[],geometry:[]});this.attributes=_.reduce(i.attributes,function(a,b){b=b.split(" ");var d=b.shift();return c[d]?a[c[d].name]=c[d].function(b.join(" ")):a[d]=b.join(" "),a},{}),"FLATE"===d.geometryType?(this.geometry=new a.Polygon(this.attributes.REF,g),this.geometry.center=new a.Point(i.geometry,e,f),this.attributes=_.omit(this.attributes,"REF")):this.geometry=b(d.geometryType,i.geometry,e,f)}}),a.Features=a.Base.extend({initialize:function(b,c){this.head=c,this.features=[],_.each(b,function(b,d){d=d.replace(":","").split(" ");var e={id:parseInt(d[1],10),geometryType:d[0],lines:b};this.features.push(new a.Feature(e,c.origo,c.enhet,this))},this)},length:function(){return this.features.length},at:function(a){return this.features[a]},getById:function(a){return _.find(this.features,function(b){return b.id===a})},all:function(){return this.features}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a){return[a.x,a.y]}a.Sosi2GeoJSON=a.Base.extend({initialize:function(a){this.sosidata=a},dumps:function(){return{type:"FeatureCollection",features:this.getFeatures(),crs:this.writeCrs()}},getFeatures:function(){return _.map(this.sosidata.features.all(),this.createGeoJsonFeature,this)},createGeoJsonFeature:function(a){return{type:"Feature",id:a.id,properties:a.attributes,geometry:this.writeGeometry(a.geometry)}},writeGeometry:function(c){if(c instanceof a.Point)return{type:"Point",coordinates:b(c)};if(c instanceof a.LineString)return{type:"LineString",coordinates:_.map(c.kurve,b)};if(c instanceof a.Polygon){var d=_.map(c.flate,b),e=_.map(c.holes,function(a){return _.map(a,b)});return{type:"Polygon",coordinates:[d].concat(e)}}throw new Error("cannot write geometry!")},writeCrs:function(){return{type:"name",properties:{name:this.sosidata.hode.srid}}}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(b){return 1===a.util.countStartingDots(b)}function c(a){return!(a[0]&&"!"!==a[0])}var d=a.Base.extend({}),e=a.Base.extend({}),f={geojson:a.Sosi2GeoJSON},g=a.Base.extend({initialize:function(b){this.hode=new a.Head(b.HODE),this.def=new d(b.DEF),this.objdef=new e(b.OBJDEF),this.features=new a.Features(_.omit(b,["HODE","DEF","OBJDEF","SLUTT"]),this.hode)},dumps:function(a){if(f[a])return new f[a](this).dumps();throw new Error("Outputformat "+a+" is not supported!")}});a.Parser=a.Base.extend({parse:function(d){var e,f=_.reduce(d.split("\n"),function(d,f){if(!c(f))if(b(f)){var g=a.util.cleanupLine(f.replace(".",""));d[g]=[],e=g}else e&&d[e].push(f);return d},{});return new g(f)}})}(SOSI);