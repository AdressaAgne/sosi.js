/*! SOSI 22-10-2013 */
var SOSI=window.SOSI||{};!function(a){"use strict";a.Base=function(){this.initialize.apply(this,arguments)},_.extend(a.Base.prototype,{initialize:function(){}}),a.Base.extend=function(a,b){var c,d=this;c=a&&_.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},_.extend(c,d,b);var e=function(){this.constructor=c};return e.prototype=d.prototype,c.prototype=new e,a&&_.extend(c.prototype,a),c.__super__=d.prototype,c}}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a){return _.rest(a.split(" ")).join(" ").trim()}function c(a){return new Array(a+1).join(".")}function d(a){return-1!==a.indexOf(":")?_.first(a.split(":")).trim():_.first(a.split(" ")).trim()}function e(a){return-1!==a.indexOf("!")&&(a=a.substring(0,a.indexOf("!"))),a.replace(/\s\s*$/,"")}function f(a,b){return e(d(a.replace(c(b),"")))}function g(a,b){_.isArray(a.objects[a.key])||(a.objects[a.key]=[]),a.objects[a.key].push(b)}function h(a){var b=_.find(a,function(a){return"."!==a});return b&&(a=a.substr(0,_.indexOf(a,b))),_.every(a,function(a){return"."===a})?a.length:0}function i(a,b){return h(a)===b}function j(a){return""===a}function k(a,c){return _.reduce(_.reject(a,j),function(a,d){return d=e(d),i(d,c)&&(a.key=f(d,c),d=b(d)),j(d)||g(a,d),a},{objects:{}}).objects}function l(b,c){if(!a.types)return c;var d=_.isArray(b)?b:SOSI.types[b];if(d&&!_.isObject(d[0])){if("Integer"===d[1])return parseInt(c,10);if("Real"===d[1])return parseFloat(c);if("Date"===d[1]){if(8===c.length)return new Date(parseInt(c.substring(0,4),10),parseInt(c.substring(4,6),10)-1,parseInt(c.substring(6,8),10));if(14===c.length)return new Date(parseInt(c.substring(0,4),10),parseInt(c.substring(4,6),10)-1,parseInt(c.substring(6,8),10),parseInt(c.substring(8,10),10),parseInt(c.substring(10,12),10),parseInt(c.substring(12,14),10))}else if(_.isString(d[1]))return'"'===c[0]||"'"===c[0]?c.substring(1,c.length-1):c}return c}function m(a,b){return function(a){return a?_.isObject(a)?a:_.isString(a)?_.reduce(a.match(/"[^"]*"|'[^']*'|\S+/g),function(a,c,d){return a[b[d][0]]=l(b[d],c),a},{}):void 0:null}}function n(b){if(a.types&&a.types[b]){var c=a.types[b];return!!c&&c[0]||b}return b}function o(a){return _.reduce(k(a,3),function(a,b,c){return a[n(c)]=l(c,b[0]),a},{})}a.util={parseTree:k,cleanupLine:e,parseFromLevel2:function(a){return _.reduce(k(a,2),function(a,b,c){return b.length&&(a[n(c)]="."===b[0][0]?o(b):b.length>1?_.map(b,function(a){return l(c,a)}):l(c,b[0])),a},{})},specialAttributes:function(){return _.reduce(SOSI.types,function(a,b,c){return _.isObject(b[1])&&(a[b[0]]={name:b[0],createFunction:m(c,b[1])}),a},{})}(),round:function(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c}},a.geosysMap={2:{srid:"EPSG:4326",def:"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs "}},a.koordsysMap={1:{srid:"EPSG:27391",def:"+proj=tmerc +lat_0=58 +lon_0=-4.666666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},2:{srid:"EPSG:27392",def:"+proj=tmerc +lat_0=58 +lon_0=-2.333333333333333 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},3:{srid:"EPSG:27393",def:"+proj=tmerc +lat_0=58 +lon_0=0 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},4:{srid:"EPSG:27394",def:"+proj=tmerc +lat_0=58 +lon_0=2.5 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},5:{srid:"EPSG:27395",def:"+proj=tmerc +lat_0=58 +lon_0=6.166666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},6:{srid:"EPSG:27396",def:"+proj=tmerc +lat_0=58 +lon_0=10.16666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},7:{srid:"EPSG:27397",def:"+proj=tmerc +lat_0=58 +lon_0=14.16666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},8:{srid:"EPSG:27398",def:"+proj=tmerc +lat_0=58 +lon_0=18.33333333333333 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},9:{srid:"EPSG:4273",def:"+proj=longlat +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +no_defs"},21:{srid:"EPSG:32631",def:"+proj=utm +zone=31 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},22:{srid:"EPSG:32632",def:"+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},23:{srid:"EPSG:32633",def:"+proj=utm +zone=33 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},24:{srid:"EPSG:32634",def:"+proj=utm +zone=34 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},25:{srid:"EPSG:32635",def:"+proj=utm +zone=35 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},26:{srid:"EPSG:32636",def:"+proj=utm +zone=35 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},31:{srid:"EPSG:23031",def:"+proj=utm +zone=31 +ellps=intl +units=m +no_defs"},32:{srid:"EPSG:23032",def:"+proj=utm +zone=32 +ellps=intl +units=m +no_defs"},33:{srid:"EPSG:23033",def:"+proj=utm +zone=33 +ellps=intl +units=m +no_defs"},34:{srid:"EPSG:23034",def:"+proj=utm +zone=34 +ellps=intl +units=m +no_defs"},35:{srid:"EPSG:23035",def:"+proj=utm +zone=35 +ellps=intl +units=m +no_defs"},36:{srid:"EPSG:23036",def:"+proj=utm +zone=36 +ellps=intl +units=m +no_defs"},50:{srid:"EPSG:4230",def:"+proj=longlat +ellps=intl +no_defs"},72:{srid:"EPSG:4322",def:"+proj=longlat +ellps=WGS72 +no_defs "},84:{srid:"EPSG:4326",def:"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs "},87:{srid:"EPSG:4231",def:"+proj=longlat +ellps=intl +no_defs "}},_.each(a.koordsysMap,function(a){proj4?proj4.defs(a.srid,a.def):Proj4js&&(Proj4js.defs[a.srid]=a.def)})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a,b){var c=a[b]||"";return c.replace(/"/g,"")}function c(a,b){return parseFloat(a[b])}function d(b){if(b=parseInt(b,10),a.koordsysMap[b])return a.koordsysMap[b].srid;throw new Error("KOORDSYS = "+b+" not found!")}function e(b){if(_.isArray(b))throw new Error("GEOSYS cannot be parsed in uncompacted form yet.");if(b=b.split(/\s+/),a.geosysMap[b[0]])return a.geosysMap[b[0]];throw new Error("GEOSYS = "+b+" not found!")}function f(a){var b=a["MIN-NØ"].split(/\s+/),c=a["MAX-NØ"].split(/\s+/);return[parseFloat(b[1]),parseFloat(b[0]),parseFloat(c[1]),parseFloat(c[0])]}function g(a){return a=_.filter(a.split(" "),function(a){return""!==a}),{x:parseFloat(a[1]),y:parseFloat(a[0])}}function h(a){return a.TRANSPAR.enhet?parseFloat(a.TRANSPAR.enhet):parseFloat(a.TRANSPAR.ENHET)}a.Head=a.Base.extend({initialize:function(a){this.setData(a)},parse:function(b){return a.util.parseFromLevel2(b)},setData:function(i){i=this.parse(i),this.eier=b(i,"geodataeier"),this.produsent=b(i,"geodataprodusent"),this.objektkatalog=b(i,"OBJEKTKATALOG"),this.verifiseringsdato=i.verifiseringsdato,this.version=c(i,"sosiVersjon"),this.level=c(i,"sosiKompleksitetNivå"),this.kvalitet=a.util.specialAttributes.kvalitet.createFunction(i.kvalitet),this.bbox=f(i.OMRÅDE),this.origo=g(i.TRANSPAR["ORIGO-NØ"]),this.enhet=h(i),this.vertdatum=b(i.TRANSPAR,"VERT-DATUM"),this.srid=i.TRANSPAR.KOORDSYS?d(i.TRANSPAR.KOORDSYS):e(i.TRANSPAR.GEOSYS)}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a){return _.filter(a,function(a){return-1===a.indexOf("NØ")})}function c(a,b){var c=_.flatten(_.map(a,function(a){var c=Math.abs(a),d=b.getById(c);if(!d)throw new Error("Fant ikke KURVE "+c+" for FLATE");var e=d.geometry.kurve;return 0>a&&(e=_.clone(e).reverse()),_.initial(e)}));return c.push(c[0]),c}function d(a){return _.map(a.trim().split(" "),function(a){return parseInt(a.replace(":",""),10)})}a.Point=a.Base.extend({knutepunkt:!1,initialize:function(b,c,d){if(_.isNumber(b))return this.x=b,this.y=c,void 0;_.isArray(b)&&(b=b[1]);var e=b.split(/\s+/),f=0;1>d&&(f=-Math.floor(Math.log(d)/Math.LN10)),this.y=a.util.round(parseInt(e[0],10)*d+c.y,f),this.x=a.util.round(parseInt(e[1],10)*d+c.x,f),e[2]&&!isNaN(e[2])&&(this.z=a.util.round(parseInt(e[2],10)*d,f)),-1!==b.indexOf(".KP")&&this.setTiepoint(b.substring(b.indexOf(".KP"),b.length).split(" ")[1])},setTiepoint:function(a){this.has_tiepoint=!0,this.knutepunktkode=parseInt(a,10)}}),a.LineString=a.Base.extend({initialize:function(b,c,d){this.kurve=_.compact(_.map(b,function(b){return-1===b.indexOf("NØ")?new a.Point(b,c,d):void 0})),this.knutepunkter=_.filter(this.kurve,function(a){return a.has_tiepoint})}}),a.LineStringFromArc=a.LineString.extend({initialize:function(c,d,e){var f=_.map(b(c),function(b){return new a.Point(b,d,e)});if(3!==f.length)throw new Error("BUEP er ikke definert med 3 punkter");var g=f[0].x,h=f[1].x,i=f[2].x,j=f[0].y,k=f[1].y,l=f[2].y,m=(g*g-h*h+j*j-k*k)/2,n=(g*g-i*i+j*j-l*l)/2,o=g-h,p=g-i,q=j-k,r=j-l,s=(r*m-q*n)/(o*r-q*p),t=(p*m-o*n)/(q*p-o*r),u=Math.sqrt(Math.pow(g-s,2)+Math.pow(j-t,2)),v=Math.atan2(j-t,g-s),w=Math.atan2(l-t,i-s),x=w-v;0>x&&(x+=2*Math.PI),x>Math.PI&&(x=-2*Math.PI+x);var y=Math.floor(32*x/2*Math.PI);0>y&&(y=-y),3>y&&(y=3),x/=y-1,this.kurve=_.map(_.range(y),function(b){var c=s+u*Math.cos(v+x*b),d=t+u*Math.sin(v+x*b);if(isNaN(c))throw new Error("BUEP: Interpolated "+c+" for point "+b+" of "+y+" in curve.");return new a.Point(c,d)}),this.knutepunkter=_.filter(f,function(a){return a.has_tiepoint})}}),a.Polygon=a.Base.extend({initialize:function(a,b){var e=a,f=[],g=a.indexOf("(");-1!==g&&(e=a.substr(0,g),f=a.substr(g,a.length)),e=d(e),f=_.map(_.reduce(f,function(a,b){return"("===b?a.push(""):")"!==b&&""!==b&&(a[a.length-1]+=b),a},[]),d),this.flate=c(e,b),this.holes=_.map(f,function(a){if(1===a.length){var d=b.getById(Math.abs(a[0]));if("FLATE"===d.geometryType)return d.geometry.flate}return c(a,b)}),this.shellRefs=e,this.holeRefs=f}})}(SOSI);var SOSI=window.SOSI||{};!function(a,b){"use strict";function c(b,c,d,e){var f={PUNKT:a.Point,TEKST:a.Point,KURVE:a.LineString,BUEP:a.LineStringFromArc,LINJE:a.LineString,FLATE:a.Polygon};if(!f[b])throw new Error("GeometryType "+b+" is not handled (yet..?)");return new f[b](c,d,e)}a.Feature=a.Base.extend({initialize:function(a,c,d,e){if(a.id===b||null===a.id)throw new Error("Feature must have ID!");this.id=a.id,this.parseData(a,c,d,e),this.geometryType=a.geometryType},parseData:function(b,c,d){var e=_.reduce(b.lines,function(a,b){return-1!==b.indexOf("..NØ")&&(a.foundGeom=!0),a.foundGeom?a.geom.push(b):(-1!==b.indexOf("..REF")&&(a.foundRef=!0,b=b.replace("..REF","")),a.foundRef?"."===b[0]?a.foundRef=!1:a.refs.push(b):a.attributes.push(b)),a},{attributes:[],geom:[],refs:[],foundGeom:!1,foundRef:!1});this.attributes=a.util.parseFromLevel2(e.attributes),this.attributes=_.reduce(this.attributes,function(b,c,d){return b[d]=a.util.specialAttributes[d]?a.util.specialAttributes[d].createFunction(c):c,b},{}),e.refs.length>0&&(this.attributes.REF=e.refs.join(" ")),this.attributes.ENHET&&(d=parseFloat(this.attributes.ENHET)),this.raw_data={geometryType:b.geometryType,geometry:e.geom,origo:c,unit:d}},buildGeometry:function(b){"FLATE"===this.raw_data.geometryType?(this.geometry=new a.Polygon(this.attributes.REF,b),this.geometry.center=new a.Point(this.raw_data.geometry,this.raw_data.origo,this.raw_data.unit),this.attributes=_.omit(this.attributes,"REF")):this.geometry=c(this.raw_data.geometryType,this.raw_data.geometry,this.raw_data.origo,this.raw_data.unit),this.raw_data=null}}),a.Features=a.Base.extend({initialize:function(b,c){this.head=c,this.features=[],this.features=_.map(b,function(b,d){d=d.replace(":","").split(/\s+/);var e={id:parseInt(d[1],10),geometryType:d[0],lines:_.rest(b)};return new a.Feature(e,c.origo,c.enhet)},this)},ensureGeom:function(a){return a&&!a.geometry&&a.buildGeometry(this),a},length:function(){return this.features.length},at:function(a){return this.ensureGeom(this.features[a])},getById:function(a){return this.ensureGeom(_.find(this.features,function(b){return b.id===a}))},all:function(){return _.map(this.features,this.ensureGeom,this)}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a){return[a.x,a.y]}function c(a,b){return _.map(a,function(a){var c=b[Math.abs(a)].index;return a>0?c:-(Math.abs(c)+1)})}a.Sosi2GeoJSON=a.Base.extend({initialize:function(a){this.sosidata=a},dumps:function(){return{type:"FeatureCollection",features:this.getFeatures(),crs:this.writeCrs()}},getFeatures:function(){return _.map(this.sosidata.features.all(),this.createGeoJsonFeature,this)},createGeoJsonFeature:function(a){return{type:"Feature",id:a.id,properties:a.attributes,geometry:this.writeGeometry(a.geometry)}},writeGeometry:function(c){if(c instanceof a.Point)return{type:"Point",coordinates:b(c)};if(c instanceof a.LineString)return{type:"LineString",coordinates:_.map(c.kurve,b)};if(c instanceof a.Polygon){var d=_.map(c.flate,b),e=_.map(c.holes,function(a){return _.map(a,b)});return{type:"Polygon",coordinates:[d].concat(e)}}throw new Error("cannot write geometry!")},writeCrs:function(){return{type:"name",properties:{name:this.sosidata.hode.srid}}}}),a.Sosi2TopoJSON=a.Base.extend({initialize:function(a){this.sosidata=a},dumps:function(a){var b=this.getPoints(),c=this.getLines(),d=this.getPolygons(c),e=b.concat(_.map(c,function(a){return a.geometry})).concat(d),f={type:"Topology",objects:{}};f.objects[a]={type:"GeometryCollection",geometries:e};var g=_.map(_.sortBy(c,function(a){return a.index}),function(a){return a.arc});return g.length&&(f.arcs=g),f},getByType:function(a){return _.filter(this.sosidata.features.all(),function(b){return b.geometry instanceof a})},getPoints:function(){var c=this.getByType(a.Point);return _.map(c,function(a){var c=_.clone(a.attributes);return c.id=a.id,{type:"Point",properties:c,coordinates:b(a.geometry)}})},getLines:function(){var c=this.getByType(a.LineString);return _.reduce(c,function(a,c,d){var e=_.clone(c.attributes);return e.id=c.id,a[c.id]={geometry:{type:"LineString",properties:e,arcs:[d]},arc:_.map(c.geometry.kurve,b),index:d},a},{})},getPolygons:function(b){var d=this.getByType(a.Polygon);return _.map(d,function(d){var e=_.clone(d.attributes);e.id=d.id;var f=[c(d.geometry.shellRefs,b)];return f=f.concat(_.map(d.geometry.holeRefs,function(d){if(1===d.length){var e=this.sosidata.features.getById(Math.abs(d[0]));if(e.geometry instanceof a.Polygon)return c(e.geometry.shellRefs,b)}return c(d,b)},this)),{type:"Polygon",properties:e,arcs:f}},this)}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a){return _.map(a.split("\n"),function(a){return 0!==a.indexOf("!")&&(a=a.split("!")[0]),a.replace(/^\s+|\s+$/g,"")})}var c=a.Base.extend({}),d=a.Base.extend({}),e={geojson:a.Sosi2GeoJSON,topojson:a.Sosi2TopoJSON},f=a.Base.extend({initialize:function(b){this.hode=new a.Head(b.HODE||b["HODE 0"]),this.def=new c(b.DEF),this.objdef=new d(b.OBJDEF),this.features=new a.Features(_.omit(b,["HODE","HODE 0","DEF","OBJDEF","SLUTT"]),this.hode)},dumps:function(a){if(e[a])return new e[a](this).dumps(_.rest(arguments));throw new Error("Outputformat "+a+" is not supported!")}});a.Parser=a.Base.extend({parse:function(c){return new f(a.util.parseTree(b(c),1))}})}(SOSI);